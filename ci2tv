#!/usr/bin/env bash

# Read a chartink (https://chartink.com) generated file and convert it to
# tradingview readable file.

usage () {
    echo "Usage: $0 FILE | [-n]|[-l][-h]"
    exit 0
}

if [ $# -ne 1 ]; then
    usage
    exit 1
fi

print_next_scan () {
    if [[ ! -f ~/.last_scan ]]; then
        echo "File ~/.last_scan not found. Scan to create the file."
    else
        prev_date=`< ~/.last_scan`
        date --date="$prev_date + 2 weeks" +'%A %d %B %Y'
    fi

    exit 0
}

print_last_scan () {
    if [[ ! -f ~/.last_scan ]]; then
        echo "File ~/.last_scan not found. Scan to create the file."
    else
        cat ~/.last_scan
    fi
    exit 0
}

while getopts "nlh" arg; do
    case $arg in
        n)
            print_next_scan
            ;;
        l)
            print_last_scan
            ;;
        h | *)
            usage
            ;;
    esac
done

ci_file="$1"

if [[ ! -f $ci_file ]]; then
    echo "File $ci_file not found"
    exit 1
fi

awk -F, '{ print $3 }' "$ci_file" |
    awk -F\" '{ print "NSE:"$2 }' |
    sed 1d

# Update the scan date
date '+%A %d %B %Y' > ~/.last_scan


